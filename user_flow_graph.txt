FAYDAPASS USER FLOW GRAPH
========================

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              FAYDAPASS ECOSYSTEM                              │
└─────────────────────────────────────────────────────────────────────────────────┘

                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              ENTRY POINTS                                     │
└─────────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │   Landing   │    │   Direct    │    │   Admin     │
    │   Page (/)  │    │   Verify    │    │   Login     │
    └─────────────┘    │   (/verify) │    │(/admin/login)│
           │           └─────────────┘    └─────────────┘
           │                   │                   │
           ▼                   ▼                   ▼
    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │   Marketing │    │   OAuth     │    │   Supabase  │
    │   Content   │    │   Init      │    │   Auth      │
    └─────────────┘    └─────────────┘    └─────────────┘

                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              PUBLIC USER FLOW                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  STEP 1: VERIFICATION INITIATION                                              │
└─────────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────┐
    │   /verify   │
    │             │
    │ • PKCE Gen  │
    │ • State Gen │
    │ • OAuth URL │
    │ • Consent   │
    └─────────────┘
           │
           ▼
    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │ sessionStorage│   │   Fayda     │    │   OAuth     │
    │             │   │   eSignet    │    │   Params    │
    │ • code_verifier│   │   Auth      │    │             │
    │ • oauth_state│   │   Endpoint   │    │ • client_id │
    └─────────────┘    └─────────────┘    │ • scope     │
           │                   │           │ • state     │
           │                   ▼           │ • nonce     │
           │           ┌─────────────┐    └─────────────┘
           │           │   Redirect  │
           │           │   to Fayda  │
           │           └─────────────┘
           │                   │
           │                   ▼
           │           ┌─────────────┐
           │           │   User      │
           │           │   Authenticates│
           │           │   with Fayda│
           │           └─────────────┘
           │                   │
           │                   ▼
           └───────────────────┼───────────────────┐
                               │                   │
                               ▼                   ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│  STEP 2: OAUTH CALLBACK HANDLING                                              │
└─────────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │   /callback │    │   State     │    │   Code      │
    │             │    │   Validation│    │   Exchange  │
    │ • Validate  │    │             │    │             │
    │ • Exchange  │    │ • oauth_state│   │ • /api/token│
    │ • Store     │    │ • Security  │    │ • JWT Assert│
    └─────────────┘    └─────────────┘    └─────────────┘
           │                   │                   │
           ▼                   ▼                   ▼
    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │ sessionStorage│   │   Success   │    │   Token     │
    │             │   │   Path       │    │   Response  │
    │ • access_token│   │             │    │             │
    │ • user_info │   │ • /verified  │    │ • access_token│
    └─────────────┘    └─────────────┘    │ • expires_in│
           │                   │           └─────────────┘
           │                   │                   │
           │                   ▼                   ▼
           │           ┌─────────────┐    ┌─────────────┐
           │           │   /verified │    │   User Info │
           │           │             │    │   Fetch     │
           │           │ • Display   │    │             │
           │           │ • Download  │    │ • /api/userinfo│
           │           │ • Share     │    │ • Bearer Token│
           │           └─────────────┘    └─────────────┘
           │                   │                   │
           │                   ▼                   ▼
           │           ┌─────────────┐    ┌─────────────┐
           │           │   /dashboard│    │   User Data │
           │           │             │    │             │
           │           │ • Welcome   │    │ • Profile   │
           │           │ • API Key   │    │ • Contact   │
           │           │ • Actions   │    │ • Fayda ID  │
           │           └─────────────┘    └─────────────┘
           │                   │
           │                   ▼
           └───────────────────┼───────────────────┐
                               │                   │
                               ▼                   ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│  STEP 3: ADMIN FLOW                                                          │
└─────────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │/admin/login │    │   Supabase  │    │   Role      │
    │             │    │   Auth      │    │   Check     │
    │ • Email     │    │             │    │             │
    │ • Password  │    │ • Session   │    │ • Admin     │
    │ • Validation│    │ • Refresh   │    │ • Viewer    │
    └─────────────┘    └─────────────┘    └─────────────┘
           │                   │                   │
           ▼                   ▼                   ▼
    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │   Success   │    │   Session   │    │   Access    │
    │   Redirect  │    │   Management│    │   Control   │
    │             │    │             │    │             │
    │ • /admin/dashboard│   • Auto-refresh│   • Route Guard│
    └─────────────┘    └─────────────┘    └─────────────┘
           │                   │                   │
           ▼                   ▼                   ▼
    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │   Admin     │    │   Admin     │    │   Admin     │
    │   Dashboard │    │   Layout    │    │   Pages     │
    │             │    │             │    │             │
    │ • Stats     │    │ • Sidebar   │    │ • /users    │
    │ • Recent    │    │ • Nav       │    │ • /verifications│
    │ • Actions   │    │ • Auth      │    │ • /webhooks │
    └─────────────┘    └─────────────┘    └─────────────┘

                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              API FLOW                                         │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  TOKEN EXCHANGE API                                                           │
└─────────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │ /api/token  │    │   JWT       │    │   Fayda     │
    │             │    │   Creation  │    │   Token     │
    │ • POST      │    │             │    │   Endpoint  │
    │ • PKCE      │    │ • RS256     │    │             │
    │ • Exchange  │    │ • 2h Exp    │    │ • OAuth2   │
    └─────────────┘    └─────────────┘    └─────────────┘
           │                   │                   │
           ▼                   ▼                   ▼
    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │   Response  │    │   Client    │    │   Token     │
    │             │    │   Assertion │    │   Response  │
    │ • access_token│   │             │    │             │
    │ • expires_in│   │ • Private Key│   │ • Bearer    │
    │ • token_type│   │ • Base64     │   │ • Scope     │
    └─────────────┘    └─────────────┘    └─────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  USERINFO API                                                                │
└─────────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │/api/userinfo│    │   Bearer    │    │   Fayda     │
    │             │    │   Token     │    │   UserInfo  │
    │ • GET       │    │             │    │   Endpoint  │
    │ • Validation│    │ • Authorization│  │             │
    │ • Proxy     │    │ • Header    │    │ • OIDC     │
    └─────────────┘    └─────────────┘    └─────────────┘
           │                   │                   │
           ▼                   ▼                   ▼
    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │   User      │    │   Multiple  │    │   User      │
    │   Data      │    │   Attempts  │    │   Profile   │
    │             │    │             │    │             │
    │ • Profile   │    │ • POST/GET  │    │ • Name      │
    │ • Contact   │    │ • Headers   │    │ • Email     │
    │ • Fayda ID  │    │ • Formats   │    │ • Phone     │
    └─────────────┘    └─────────────┘    └─────────────┘

                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              DATA FLOW                                        │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  CLIENT-SIDE STORAGE                                                          │
└─────────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │ sessionStorage│   │   Browser   │    │   Temporary │
    │             │   │   Session    │    │   Storage   │
    │ • access_token│   │             │    │             │
    │ • user_info │   │ • Tab-based  │    │ • Lost on   │
    │ • oauth_state│   │ • Memory     │    │   close     │
    │ • code_verifier│  │ • Secure     │    │ • No persist│
    └─────────────┘    └─────────────┘    └─────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  SERVER-SIDE STORAGE                                                          │
└─────────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │   Supabase  │    │   Verifications│  │   Admin     │
    │   Auth      │    │   Table      │    │   Users     │
    │             │    │             │    │             │
    │ • Sessions  │    │ • user_email│    │ • Roles     │
    │ • Users     │    │ • status    │    │ • Permissions│
    │ • Refresh   │    │ • scores    │    │ • Access    │
    └─────────────┘    └─────────────┘    └─────────────┘

                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              SECURITY FLOW                                    │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  OAUTH 2.0 SECURITY                                                          │
└─────────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │   PKCE      │    │   State     │    │   Nonce     │
    │   Flow      │    │   Validation│    │   Validation│
    │             │    │             │    │             │
    │ • code_verifier│  │ • CSRF      │    │ • Replay   │
    │ • code_challenge│ │ • Protection│    │ • Attack   │
    │ • S256      │    │ • Session   │    │ • Prevention│
    └─────────────┘    └─────────────┘    └─────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  JWT SECURITY                                                                │
└─────────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │   Client    │    │   RSA256    │    │   Expiration│
    │   Assertion │    │   Signing   │    │   Control   │
    │             │    │             │    │             │
    │ • Private Key│   │ • JWK       │    │ • 2h Limit │
    │ • Base64    │   │ • Algorithm │    │ • Timeout   │
    │ • RS256     │   │ • Secure    │    │ • Rotation  │
    └─────────────┘    └─────────────┘    └─────────────┘

                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              ERROR HANDLING                                  │
└─────────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │   OAuth     │    │   Token     │    │   UserInfo  │
    │   Errors    │    │   Errors    │    │   Errors    │
    │             │    │             │    │             │
    │ • access_denied│  │ • invalid_grant│  │ • 401      │
    │ • invalid_request│ │ • invalid_client│ │ • 403      │
    │ • server_error│  │ • invalid_token│  │ • 500      │
    └─────────────┘    └─────────────┘    └─────────────┘
           │                   │                   │
           ▼                   ▼                   ▼
    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │   Redirect  │    │   Retry     │    │   Fallback  │
    │   to /verify│    │   Logic     │    │   Display   │
    │             │    │             │    │             │
    │ • Error Msg │    │ • Multiple  │    │ • Debug Info│
    │ • Try Again │    │ • Attempts  │    │ • User Guide│
    │ • Support   │    │ • Timeout   │    │ • Contact   │
    └─────────────┘    └─────────────┘    └─────────────┘

                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              LIMITATIONS                                     │
└─────────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │   No Refresh│    │   Session   │    │   No Token  │
    │   Tokens    │    │   Storage   │    │   Validation│
    │             │    │   Only      │    │             │
    │ • Re-auth   │    │ • Browser   │    │ • Expiration│
    │ • Required  │    │ • Close     │    │ • Check     │
    │ • UX Impact │    │ • Lost      │    │ • Missing   │
    └─────────────┘    └─────────────┘    └─────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              FUTURE ENHANCEMENTS                             │
└─────────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
    │   Refresh   │    │   Persistent│    │   Token     │
    │   Token     │    │   Storage   │    │   Validation│
    │   Flow      │    │             │    │             │
    │             │    │ • httpOnly  │    │ • Exp Check │
    │ • Auto-refresh│  │ • Cookies   │    │ • Auto-refresh│
    │ • Silent    │   │ • Secure    │    │ • Interceptor│
    └─────────────┘    └─────────────┘    └─────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              END OF FLOW                                     │
└─────────────────────────────────────────────────────────────────────────────────┘

KEY LEGEND:
==========
│  = Vertical connection
▼  = Downward flow
┌─┐ = Process/Component box
└─┘ = End of process
─── = Horizontal connection
```

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              FLOW SUMMARY                                    │
└─────────────────────────────────────────────────────────────────────────────────┘

PUBLIC USER JOURNEY:
User → Landing → Verify → Fayda OAuth → Callback → Token Exchange →
Verified → Dashboard

ADMIN JOURNEY:
Admin → Login → Auth → Dashboard → Management Pages

API JOURNEY:
Client → Token API → JWT → Fayda → UserInfo API → Data

SECURITY JOURNEY:
PKCE → State → Nonce → JWT → Bearer → Validation

DATA JOURNEY:
SessionStorage → API Calls → Supabase → Persistent Storage

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              END GRAPH                                       │
└─────────────────────────────────────────────────────────────────────────────────┘
